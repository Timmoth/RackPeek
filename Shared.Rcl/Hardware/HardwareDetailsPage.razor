@page "/resources/hardware/{HardwareName}"

@using RackPeek.Domain.Persistence
@using RackPeek.Domain.Resources.AccessPoints
@using RackPeek.Domain.Resources.Desktops
@using RackPeek.Domain.Resources.Firewalls
@using RackPeek.Domain.Resources.Hardware
@using RackPeek.Domain.Resources.Laptops
@using RackPeek.Domain.Resources.Servers
@using RackPeek.Domain.Resources.Switches
@using RackPeek.Domain.Resources.SystemResources
@using RackPeek.Domain.Resources.UpsUnits
@using Shared.Rcl.AccessPoints
@using Shared.Rcl.Desktops
@using Shared.Rcl.Firewalls
@using Shared.Rcl.Laptops
@using Shared.Rcl.Routers
@using Shared.Rcl.Servers
@using Shared.Rcl.Switches
@using Shared.Rcl.Ups
@using Router = RackPeek.Domain.Resources.Routers.Router
@inject IResourceCollection Repo
@inject GetHardwareSystemTreeUseCase GetHardwareSystemTreeUseCase
@inject NavigationManager Nav

<PageTitle>Hardware Details</PageTitle>

<ResourceBreadCrumbComponent
    ResourceType="ResourceType.Hardware"
    ResourceName="@HardwareName"/>

<div class="min-h-screen bg-zinc-950 text-zinc-200 font-mono p-6">
    @if (_hardware is null && !_loading)
    {
        <div class="text-zinc-500">Hardware not found</div>
    }
    else if (_loading)
    {
        <div class="text-zinc-500">loading hardware…</div>
    }
    else
    {
        <h1 class="text-lg text-zinc-100 mb-6">
            @_hardware.Name (@_hardware.Kind)
        </h1>

        @if (_hardware is Server server)
        {
            <ServerCardComponent Server="server" OnDeleted="DeleteCallback"/>
        }
        else if (_hardware is Desktop desktop)
        {
            <DesktopCardComponent Desktop="desktop" OnDeleted="DeleteCallback"/>
        }
        else if (_hardware is AccessPoint accessPoint)
        {
            <AccessPointCardComponent AccessPoint="accessPoint" OnDeleted="DeleteCallback"/>
        }
        else if (_hardware is Switch _switch)
        {
            <SwitchCardComponent Switch="_switch" OnDeleted="DeleteCallback"/>
        }
        else if (_hardware is Laptop laptop)
        {
            <LaptopCardComponent Laptop="laptop" OnDeleted="DeleteCallback"/>
        }
        else if (_hardware is Firewall firewall)
        {
            <FirewallCardComponent Firewall="firewall" OnDeleted="DeleteCallback"/>
        }
        else if (_hardware is Router router)
        {
            <RouterCardComponent Router="router" OnDeleted="DeleteCallback"/>
        }
        else if (_hardware is Ups ups)
        {
            <UpsCardComponent Ups="ups" OnDeleted="DeleteCallback"/>
        }
        else
        {
            <div class="text-zinc-400">
                No detailed view for hardware type: @_hardware.Kind
            </div>
        }

        @if (_tree is not null && _tree.Systems.Any())
        {
            <HardwareDependencyTreeComponent Tree="_tree"/>
        }
        else
        {
            <div class="text-zinc-400 m-2">
                No child systems / services
            </div>
        }

        <div class="m-4">
            <AddResourceComponent TResource="SystemResource"
                                  Placeholder="System name"
                                  OnCreated="NavigateToNewResource"
                                  RunsOn="@(new List<string>(){HardwareName})"/>
        </div>
    }
</div>

@code {
    [Parameter] public string HardwareName { get; set; } = string.Empty;

    private Hardware? _hardware;
    private bool _loading = true;
    private HardwareDependencyTree? _tree;

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;
        _hardware = null;
        _tree = null;

        _hardware = await Repo.GetByNameAsync(HardwareName) as Hardware;

        if (!string.IsNullOrEmpty(_hardware?.Name))
        {
            _tree = await GetHardwareSystemTreeUseCase.ExecuteAsync(_hardware.Name);
        }

        _loading = false;
    }

    private async Task DeleteCallback(string obj)
    {
        Nav.NavigateTo("/hardware/tree");
    }

    private Task NavigateToNewResource(string serverName)
    {
        Nav.NavigateTo($"resources/systems/{Uri.EscapeDataString(serverName)}");
        return Task.CompletedTask;
    }

}
